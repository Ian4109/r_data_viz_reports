---
title: "New Taipei Income per Household (Tax Year 2022)"
author: "User"
format: html
---

This notebook documents how the per-village average comprehensive income per household is calculated from `data/income_distribution_by_village_2022_newTaipei.csv` (see codebook: `codebook/income_distribution_by_village_2022_newTaipei.md`).

## Setup

```{r}
library(dplyr)
library(readr)
library(sf)
library(ggplot2)
library(stringr)
```

## Load data

CSV includes a UTF-8 BOM; read with the matching encoding and keep the English headers provided in the codebook.

```{r}
income_path <- "../data/income_distribution_by_village_2022_newTaipei.csv"
income_raw <- read.csv(income_path, check.names = FALSE, fileEncoding = "UTF-8-BOM")

dglimpse <- function(df) {
  tibble::tibble(
    n_rows = nrow(df),
    n_cols = ncol(df),
    sample_region = df$`Region Name`[1]
  )
}
dglimpse(income_raw)
```

## Calculate mean income per household

Rename columns to concise snake_case and compute `mean_income_calc = total_income / tax_units`. The dataset already reports a mean; we calculate it to verify consistency.

```{r}
income_ntpc <- income_raw %>%
  rename(
    region = `Region Name`,
    village = `Village Name`,
    tax_units = `Tax Units (Households)`,
    total_income = `Total Comprehensive Income`,
    mean_income_reported = `Mean Income`
  ) %>%
  mutate(mean_income_calc = total_income / tax_units)

income_ntpc %>%
  select(region, village, tax_units, total_income, mean_income_reported, mean_income_calc) %>%
  slice_head(n = 5)
```

## Validate reported mean vs. calculated mean

Check that the reported mean matches the calculation across all villages.

```{r}
income_ntpc %>%
  mutate(diff = mean_income_reported - mean_income_calc) %>%
  summarize(
    max_abs_diff = max(abs(diff), na.rm = TRUE),
    mean_abs_diff = mean(abs(diff), na.rm = TRUE)
  )
```

## Top and bottom villages by calculated mean income

Review extremes to understand the spread.

```{r}
# Top 5
income_ntpc %>%
  arrange(desc(mean_income_calc)) %>%
  select(region, village, tax_units, mean_income_calc, mean_income_reported) %>%
  slice_head(n = 5)

# Bottom 5
income_ntpc %>%
  arrange(mean_income_calc) %>%
  select(region, village, tax_units, mean_income_calc, mean_income_reported) %>%
  slice_head(n = 5)
```

## Notes

- Monetary unit is not stated in the CSV; based on similar MOF tables it is likely thousand NTD—confirm with source metadata.
- If differences appear between reported and calculated means, revisit unit assumptions and rounding rules from the source.

## Map: classify mean income into low/mid/high

Use the official village boundaries shapefile, keep only New Taipei, join on `COUNTYNAME + TOWNNAME + VILLNAME`, and classify the calculated mean income into terciles.

```{r}
shp_path <- "../data/raw/村(里)界(TWD97經緯度)1141031/VILLAGE_NLSC_11401031.shp"
villages_sf <- st_read(shp_path, quiet = TRUE) %>%
  filter(COUNTYNAME == "新北市") %>%
  mutate(join_key = paste0(COUNTYNAME, TOWNNAME, VILLNAME))

income_ntpc_geo <- income_ntpc %>%
  mutate(
    county = "新北市",
    district = str_remove(region, "^新北市"),
    join_key = paste0(county, district, village),
    mean_class = ntile(mean_income_calc, 3),
    mean_class = factor(mean_class, levels = 1:3, labels = c("Low", "Mid", "High"))
  )

income_map <- villages_sf %>%
  left_join(income_ntpc_geo, by = "join_key")

income_map %>%
  summarize(
    matched = sum(!is.na(mean_class)),
    missing = sum(is.na(mean_class))
  )
```

### Choropleth

```{r}
ggplot(income_map) +
  geom_sf(aes(fill = mean_class), color = NA) +
  scale_fill_manual(
    values = c("Low" = "#d4eac7", "Mid" = "#74c476", "High" = "#006d2c"),
    na.value = "gray90",
    name = "Mean income (tercile)"
  ) +
  labs(
    title = "New Taipei: Mean Comprehensive Income per Household (2022)",
    subtitle = "Villages grouped into terciles of calculated mean income"
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold")
  )
```
